INSERT INTO "EDP_DB_UAT"."DW"."DW_CASE"(ID,ISDELETED,ISCURRENT,EFFECTIVE_START_DATE,EFFECTIVE_END_DATE,HASH_KEY,CHECKSUM,MAT_RUN_ID)

SELECT ID,ISDELETED,CASE WHEN EFFECTIVE_END_DATE = '2100-01-01 00:00:00' THEN 1 ELSE 0 END AS ISCURRENT
,EFFECTIVE_START_DATE,EFFECTIVE_END_DATE,MAT_RUN_ID

FROM (SELECT ID,ISDELETED,ISCURRENT,EFFECTIVE_START_DATE
,IFNULL(EFFECTIVE_END_DATE,TO_TIMESTAMP_NTZ('2100-01-01 00:00:00')) AS EFFECTIVE_END_DATE,MAT_RUN_ID

FROM (SELECT ID,ISDELETED,ISCURRENT,case when rnk = 1 then createddate else LASTMODIFIEDDATE END AS EFFECTIVE_START_DATE,
LEAD(lastmodifieddate) OVER(PARTITION BY ID ORDER BY[lastmodifieddate] ASC)  AS EFFECTIVE_END_DATE
,HASH("ID") AS HASH_KEY,HASH("QM_REVIEWED__C") AS CHECKSUM,999999 AS MAT_RUN_ID

FROM (SELECT * ,RANK() OVER (PARTITION BY ID ORDER BY LASTMODIFIEDDATE ASC) RNK FROM "EDP_DB_UAT"."TD_HISTORY"."DL_CASE")
));

-----------------------------------------
DELETE FROM my_table
WHERE (record_id, load_date) NOT IN (
    SELECT record_id, load_date
    FROM (
        SELECT record_id,
               load_date,
               ROW_NUMBER() OVER (PARTITION BY record_id ORDER BY load_date DESC) AS rn
        FROM my_table
    ) sub
    WHERE rn <= 1
       OR load_date >= CURRENT_DATE - INTERVAL '7 days'
);

--------------------------------------
What this SQL Does (Simple Explanation)
	•	Keeps latest record per business key
	•	Keeps any changes made in the last 7 days
	•	Deletes:
	•	Older versions beyond 7 days
	•	Unnecessary historical records
